from cryptography318.number.crypto_functions import *
from cryptography318.number.prime import *
from cryptography318.core.tools import *


def problem_1():
    values = read_mm_int()
    m1 = string_to_int("Who controls the past controls the future. Who controls the present controls the past.\n1984")
    p = values['p']
    A_k = values['c12'] * pow(m1, -1, p)
    A = values['A']
    c22 = values['c22']

    i = 7
    A_k_i = pow(A_k, i, p)
    m = (c22 * pow(A_k_i, -1, p)) % p
    print(int_to_string(m))


def problem_2():
    values = read_mm_int()
    g = values['g']
    A = values['A']
    p = values['p']
    c1 = values['c1']
    c2 = values['c2']
    a = pollard_rho_dlp(g, A, p)
    m = (pow(c1, -a, p) * c2) % p
    print(int_to_string(m))


def problem_3():
    values = read_mm_int()
    g = values['g']
    A = values['A']
    p = values['p']
    c1 = values['c1']
    c2 = values['c2']
    q = values['q']
    d = values['d']
    a = pollard_rho_dlp(g, A, p)
    b = (pow(c1, -a, p) * c2) % p
    m = (d * pow(b, -1, q)) % q
    print(int_to_string(m))


def problem_4():
    values = read_mm_int()
    n = values['n']
    e = values['e']
    c = values['c']
    q = pollard_p1(n)
    p = n // q
    d = pow(e, -1, (p - 1) * (q - 1))
    m = pow(c, d, n)
    print(int_to_string(m))


def problem_5():
    values = read_mm_int()
    n = values['n']
    e_vals = [values[f'e{i}'] for i in range(1, 4)]
    c_vals = [values[f'c{i}'] for i in range(1, 4)]
    g, u, v, w = extended_gcd(*e_vals)
    m = prod(map(lambda c, d: pow(c, d, n), c_vals, [u, v, w])) % n
    print(int_to_string(m))


def problem_6():
    values = read_mm_int()
    p = values['p']
    q = values['q']
    n = pow(p, 2) * pow(q, 2)
    e = values['e']
    c = values['c']

    phi = p * (p - 1) * q * (q - 1)
    d = pow(e, -1, phi)
    m = pow(c, d, n)
    print(int_to_string(m))


def problem_7():
    values = read_mm_int()
    q = isqrt(values['ord'])
    E = EllipticCurve(values['a'], values['b'], values['p'])
    P = E.point(2451008879130064327777342023581756508868964219111482969365984406124024941101203769454565999600546017292541656033128092620506258638194950258825961017341291455344697114202749598932290729380603649028885765192003850420782482543257205494705695239921548160895008400686906444752799314104442575886380311731291233425055178952485181185455579140039872857521735786504298245879719185081506723744442634240265608280995466514093047237372652435197756305771870209754362733271977872410249179285539129601981351183932186123427960234809557621191801128333457223778833060000163956060277513977914521048900508029396004432677275070387962766121632786963084615982032475490296829546438279583677473604475240261825186388441612231422893278092701, 2084658128563191847518932503559163363045876909515083207234475912127885702079274763678469177527049473527980211663618564482587405845185450007302701636952604668898481459670933086050908256453613756019872109319265125366102540535516595572311220901220015822453468987840273969795852643091302561838604063635675914845706271895741535350460491845284993997358491477935092210197291495261447483152815388491149644269391887247890630584471262179843146107083431349088464803913867365206029678409421571280008617504187124049700767792145617361799321768383373975601351304264287250199209480306981810038135936796337475928089178203546404415590704281133555300644509633709049660068247256625962316005215715148403625642075631455929298696290965)
    QA = E.point(1069448234460038369616526421219978400477837422768687925782923253451555555241265695519012360470477727748934365873325421108223467392996034322927812949483514324430707919924065946847367388275839633598650885378835814790347830996411018049979014708380330119009339580099031525971375790439709486139299138016000520701446000269964687366845261855352255834758556797334154468022285663179648199750902031034403786341459171948055780489334713148073579718363779479774956155427611733745179584213464912225384272005203634592831164944862155328384032812229033909468707706559688027211958868300824247280097032241577543006855346110903116959490210624929890722351097531848134134539142010560125878371458672341534867084963397447490315679709590, 893141362845085747135053537331168596231248265408303226728694646064808188098997726672243163574086715210426309460895449478870616850429231395541813912070199258322038158968930504814149988231948928540238497216032799243890272313642239121745731373156255684542052536783873766511981012534382399044054319037686781643857070837390104147163835579192443699464478710618764440531032002416059815184000323751597804951570105684800352020328133647276879440927426643335575067266244817151258776522682709702180586908305897469831836139934059618402723931790896359236006890423727050581018849515667784663746433599935351241367463309382276972079506751875805397960775718908935097129630933780533107324348317313826163608625185008444445174394637)
    C1 = E.point(4257059985575237371478028310787648592762867823128261592179149948560101560293439977480936105517387859544492260934096380913627935943353927510306194504329148468224474994921564734567613055905952236098636793012715931649246775692341385966212934805846812031010772668138157444157273830249325696557986986286575369749382917489707194273570781716233500957943283789973447574577328032070123100131961574445068419119766868853152511270782770830900123541445021499252889733821975955517295972387952877729132474091786798554049253309571816647842458387856969572956994921759098774839344944267633837126483083072415887548860332831961539979401428436783488121737446019410314557582458101411470451294841168030358823181997862412197373123116917, 1923468424955780887319491874827545362348915130062373931652844992810900341114713765054307073270573489906465590377955070938347403045755859058630977286026307597504289648366882510124663631291186379235037745578826846781532806845912153617599386175779887305182880228082018173313929936161659015050309795414137327336755404367354833935453200984223203550423480175022474657808840657972530101607657581799215254828313458519201892634050195049478422297353403854308202138338028955554507551890605724440606292633179141988414440513903324112272558207288369291222888303280108246785007294749558366105881442023426024327850056393254607396912412833947862679043707294025489092355548860128865104540203528338861459263095625111458485287737220)
    C2 = E.point(2123625335970817129224415409668629162560054371696385295267136815521832380032698851383209907264836177037955161107477626662679024931267321581101661195403056797911506689186248034674154087379074822920118829342697774460181602879540498232781918899790480428723045810844435371360816293997925440693726651281869514138007415328653506925499857293577049006626296401578286825719349645273419642909801979655000719212031103950350372276378046797679782708935931712021678227423052490633478460358090948058872145163458766514699404452108775985814156232261504838263452286004453531957469324071258928534191219158309305356060025741670365628698665531014600630560464735050638239975398662150347801658373274006646186232127788838487689822256456, 3864171220759223988623676848983148058083763076125398712017263862158184586179928965027188800492502335602944442568221828456374149756884066224297785280706113367808349467933306063108597736643185821745186670561624352738086648647794347688619325586769767557588948178714529655747081889558352301889540033561285702123905223817884499158588502724397283631493318005858906642286068837357720253240322847038511610781196458837678479872135508280149937013708412353471646175629200509706292340383353396785492614627274608296024388595915039488752571780225353550366454101225699114576938649536944242007743526045627676281498564935573994423197231687975404795571961895357158757177875079029158213274500043608074909518495872507467935346863913)

    # x = elliptic_bsgs(P * q, QA * q, q)
    x = 643749  # this is hard-coded to avoid re-running instance of BSGS

    # s = elliptic_bsgs(P * q, QA - P * x, q); s = 190856
    # x1 = x + s * q
    x1 = 155189665325  # this is hard-coded to avoid re-running instance of BSGS

    M = C2 - x1 * C1
    print(elliptic_to_string(M))


def problem_8():
    def alpha_to_num(s):
        return sum(map(lambda c, n: (ord(c) - 97) * n, s[::-1], map(lambda i: pow(26, i), range(len(s)))))

    def num_to_alpha(n):
        return ''.join(map(lambda v: chr(v + 97), to_base(n, 26)[::-1]))

    assert (n := alpha_to_num("hithere")) == 2266270166 and num_to_alpha(n) == "hithere"

    frequencies = [.082, .015, .028, .043, .127, .022, .020, .061, .070, .002, .008, .040, .024, .067, .075, .019,
                   .001, .060, .063, .091, .028, .010, .023, .001, .020, .001]

    def get_freq(s):
        curr_freq = Array([0] * 26)
        for c in s:
            n = ord(c) - 97
            curr_freq[n] += 1
        return dot(frequencies, curr_freq / len(s))

    values = read_mm_int()

    c = values['c']
    p = values['p']

    for a in range(pow(10, 4), pow(10, 5)):
        m = (c * pow(a, -1, p)) % p
        if abs(get_freq(num_to_alpha(m)) - 0.065) < .005:
            print(a)
            print(num_to_alpha(m))
            break
